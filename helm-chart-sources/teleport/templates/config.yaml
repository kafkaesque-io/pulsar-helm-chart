apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "teleport.fullname" . }}
  labels:
{{ include "teleport.labels" . | indent 4 }}
data:
  teleport.yaml: |-
    teleport:
      log:
        output: stderr
        severity: {{ .Values.config.logLevel }}
      data_dir: /var/lib/teleport
      storage:
        type: {{ .Values.config.storage_type }}

    auth_service:
      enabled: {{ .Values.config.auth_service.enabled }}
      authentication:
        type: {{ .Values.config.auth_type }}
        second_factor: {{ .Values.config.auth_second_factor}}
      public_addr: {{ .Values.config.public_addr }}:3025
      cluster_name: {{ .Values.config.cluster_name }}
      {{- if .Values.config.static_join }}
      tokens:
        - trusted_cluster:{{ .Values.config.static_join.token }}
      {{- end }}

    ssh_service:
      enabled: {{ .Values.config.ssh_service.enabled }}
      public_addr: {{ .Values.config.public_addr }}:3022
      commands:
      - name: hostname
        command: [/bin/hostname]
        period: 5m0s
      - name: uptime
        command: [/usr/bin/uptime, -p]
        period: 5m0s

    proxy_service:
      enabled: {{ .Values.config.ssh_service.enabled }}
      public_addr: {{ .Values.config.public_addr }}:3080
      ssh_public_addr: {{ .Values.config.public_addr }}:3023
      web_listen_addr: 0.0.0.0:3080
      listen_addr: 0.0.0.0:3023
      {{- if .Values.proxy.tls.enabled }}
      https_key_file: {{ .Values.config.https_key_file }}
      https_cert_file: {{ .Values.config.https_cert_file }}
      {{- end }}
      kube_public_addr: [{{ .Values.config.cluster_name }}]
      kube_listen_addr: 0.0.0.0:3026


      # kubernetes section configures
      # kubernetes proxy protocol support
    kubernetes_service:
      enabled: {{ .Values.config.kubernetes.enabled }}
      listen_addr: 0.0.0.0:3027
      kube_cluster_name: {{ .Values.config.cluster_name }}
{{- if .Values.config.trusted_cluster.enabled }}
  trusted-cluster.yaml: |-
    kind: trusted_cluster
    version: v2
    metadata:
      # the name of a trusted cluster 
      name: {{ .Values.config.trusted_cluster.name }}
    spec:
      # this field allows to create tunnels that are disabled, but can be enabled later.
      # this is the only field that can be changed later.
      enabled: true
      # the token expected by the "main" cluster:
      token: {{ .Values.config.trusted_cluster.token }}
      # the address in 'host:port' form of the reverse tunnel listening port on the
      # "master" proxy server:
      tunnel_addr: {{ .Values.config.trusted_cluster.address }}:3024
      # the address in 'host:port' form of the web listening port on the
      # "master" proxy server:
      web_proxy_addr: {{ .Values.config.trusted_cluster.address }}:3080
      role_map:
        - remote: "sso-users"  
          local: [k8s-access]
      {{- if .Values.config.configured_users.enabled }}
        - remote: "access"  
          local: [k8s-access]
      {{- end }}

  k8s-access.yaml: |-
    kind: role
    metadata:
      description: Access k8s cluster resources
      name: k8s-access
    spec:
      allow:
        app_labels:
          '*': '*'
        db_labels:
          '*': '*'
        db_names:
        - '{{ "{{" }}internal.db_names{{ "}}" }}'
        db_users:
        - '{{ "{{" }}internal.db_users{{ "}}" }}'
        kubernetes_groups:
        - '{{ "{{" }}internal.kubernetes_groups{{ "}}" }}'
        - 'system:masters'
        kubernetes_labels:
          '*': '*'
        kubernetes_users:
        - '{{ "{{" }}internal.kubernetes_users{{ "}}" }}'
        logins:
        - '{{ "{{" }}internal.logins{{ "}}" }}'
        - root
        node_labels:
          '*': '*'
        rules:
        - resources:
          - event
          verbs:
          - list
          - read
        windows_desktop_labels:
          '*': '*'
        windows_desktop_logins:
        - '{{ "{{" }}internal.windows_logins{{ "}}" }}'
      deny: {}
      options:
        cert_format: standard
        enhanced_recording:
        - command
        - network
        forward_agent: true
        max_session_ttl: 30h0m0s
        port_forwarding: true
    version: v4
{{- end }}
{{- if .Values.config.github.enabled }}
  sso-users.yaml: |-
    kind: role
    version: v4
    metadata:
      name: sso-users
    spec:
      allow:
        logins: 
        - root
        - ec2-user
        node_labels:
          '*': '*'
        kubernetes_labels:
          '*': '*'
        kubernetes_groups:
        - 'system:masters'

  github.yaml: |-
    kind: github
    version: v3
    metadata:
      name: github
    spec:
      display: Github
      client_id: {{ .Values.config.github.client_id }}       
      client_secret: {{ .Values.config.github.client_secret }}
      redirect_url: "https://{{ .Values.config.public_addr }}:3080/v1/webapi/github/callback"
      teams_to_logins:
        - organization: {{ .Values.config.github.organization }}
          team: {{ .Values.config.github.team }}
          logins:
            - sso-users
{{- end }}
